<?xml version="1.0"?>
<project name="sjs" xmlns="http://nant.sf.net/release/0.85/nant.xsd">

	<property name="current.directory" value="${directory::get-current-directory()}" />
	<property name="project.directory" value="${directory::get-parent-directory(current.directory)}" />
	<property name="release.directory" value="${project.directory}\release" />
	<property name="example.project.directory" value="${release.directory}\example-project-src" />
	<property name="example.release.directory" value="${release.directory}\example-project-release" />

	<property name="tools.directory" value="${project.directory}\tools" />
	<property name="combiner" value="${tools.directory}\Rivet\Rivet.Console.exe" />

	<property name="project.version.major" value="1" />
	<property name="project.version.minor" value="0a" />
	<property name="project.version.revision" value="${datetime::get-year(datetime::now())}-${datetime::get-month(datetime::now())}-${datetime::get-day(datetime::now())}" />
	<property name="project.version" value="${project.version.major}.${project.version.minor}-${project.version.revision}" />

	<target 
		name="release" 
		depends="sjs-release,package" />
		/>

	<target 
		name="package" 
		depends="package-release" />
		/>


	<target name="sjs-release">
		<delete dir="${release.directory}" />
		<!-- copy sjs src files -->
		<copy todir="${release.directory}">
			<fileset basedir="${project.directory}">
				<include name="${project.directory}\src\*.*"/>
			</fileset>
		</copy>
		<copy file="${project.directory}\readme.md" tofile="${release.directory}\readme.txt" />
		<!-- combine sjs src 
		<exec 
			program="${combiner}" 
			commandline="release\src\ -v:SJS_VERSION=${project.version.major}.${project.version.minor}" 
			workingdir="${project.directory}" />
		-->

		<!-- copy example project src files -->
		<copy todir="${release.directory}\example-project-src">
			<fileset basedir="${project.directory}">
				<include name="${project.directory}\example-project.js"/>
				<include name="${project.directory}\example\*.js"/>
				<include name="${project.directory}\build\example-release.xml"/>
				<include name="${project.directory}\build\example-release.build.bat"/>
				<include name="${project.directory}\test\*.*"/>
				<include name="${project.directory}\test2.txt"/>
				<include name="${project.directory}\tools\Rivet\**"/>
			</fileset>
		</copy>
		<copy todir="${release.directory}\example-project-src">
			<fileset>
				<include name="${release.directory}\src\sjs.js"/>
			</fileset>
		</copy>
		<!-- copy release files for example project -->
		<copy todir="${example.release.directory}">
			<fileset basedir="${example.project.directory}">
				<include name="/*.*"/>
				<include name="test/**"/>
				<include name="example/**"/>
			</fileset>
		</copy>
		<copy todir="${project.directory}\release\example-project-release">
			<fileset>
				<include name="${project.directory}\example\*.bat"/>
				<include name="${project.directory}\lib\js.jar"/>
			</fileset>
		</copy>
		<exec 
			program="${combiner}" 
			commandline="${example.release.directory} -v:PRJ_VERSION=${project.version.major}.${project.version.minor}" 
			workingdir="${example.release.directory}" />

	</target>

	<target name="package-release">
		<zip zipfile="${release.directory}\sjs-v${project.version}.zip">
			<fileset basedir="${release.directory}" >
				<include name="**\**" />
			</fileset>
		</zip>
		<echo message="Finished generating package" />
	</target>
	
</project>
